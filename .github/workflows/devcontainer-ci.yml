name: Dev Container CI

on:
  push:
    branches: [master, dev]
  pull_request:

jobs:
  devcontainer-build:
    runs-on: ubuntu-latest
    env:
      CI: true
      SQL_SERVER_USER_CODESPACES: ${{ secrets.SQL_SERVER_USER_CODESPACES }}
      SQL_SERVER_PASSWORD_CODESPACES: ${{ secrets.SQL_SERVER_PASSWORD_CODESPACES }}
      SQL_SERVER_CONTAINER_SERVICE_CODESPACES: ${{ secrets.SQL_SERVER_CONTAINER_SERVICE_CODESPACES }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Start SQL Server container
        run: |
          docker run -d \
            --name sqlserver \
            -e SA_PASSWORD='YourStrong!Passw0rd' \
            -e ACCEPT_EULA=Y \
            -p 1433:1433 \
            mcr.microsoft.com/mssql/server:2022-latest

      - name: Wait for SQL Server to be ready
        run: |
          for i in {1..10}; do
            nc -z localhost 1433 && echo "✅ SQL Server is up" && break
            echo "⏳ Waiting for SQL Server..."
            sleep 5
          done

      - name: Build and run inside devcontainer
        uses: devcontainers/ci@v0.3
        with:
          runCmd: |
            echo "✅ Running inside devcontainer"
            echo "SQL_SERVER_USER_CODESPACES: ${SQL_SERVER_USER_CODESPACES:+[set]}"
            echo "SQL_SERVER_PASSWORD_CODESPACES: ${SQL_SERVER_PASSWORD_CODESPACES:+[set]}"
            echo "SQL_SERVER_CONTAINER_SERVICE_CODESPACES: ${SQL_SERVER_CONTAINER_SERVICE_CODESPACES:+[set]}"
            chmod +x .devcontainer/setup-env.sh
            bash .devcontainer/setup-env.sh
            # flask db upgrade
            # pytest
